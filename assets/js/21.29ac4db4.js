(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{408:function(s,t,e){"use strict";e.r(t);var n=e(52),a=Object(n.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"websockets"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#websockets"}},[s._v("#")]),s._v(" Websockets")]),s._v(" "),e("p",[s._v("Websockets provide real time chat for Live Streaming and in the future, other aspects of the frontend UI and mobile apps.")]),s._v(" "),e("p"),e("div",{staticClass:"table-of-contents"},[e("ul",[e("li",[e("a",{attrs:{href:"#pusher-configuration"}},[s._v("Pusher Configuration")])]),e("li",[e("a",{attrs:{href:"#starting-the-websocket-server"}},[s._v("Starting the WebSocket server")]),e("ul",[e("li",[e("a",{attrs:{href:"#using-a-different-port"}},[s._v("Using a different port")])]),e("li",[e("a",{attrs:{href:"#restricting-the-listening-host"}},[s._v("Restricting the listening host")])])])]),e("li",[e("a",{attrs:{href:"#restarting-server"}},[s._v("Restarting Server")])]),e("li",[e("a",{attrs:{href:"#ssl-support"}},[s._v("SSL Support")]),e("ul",[e("li",[e("a",{attrs:{href:"#configuration"}},[s._v("Configuration")])]),e("li",[e("a",{attrs:{href:"#server-configuration"}},[s._v("Server configuration")])]),e("li",[e("a",{attrs:{href:"#usage-with-a-reverse-proxy-like-nginx"}},[s._v("Usage with a reverse proxy (like Nginx)")])]),e("li",[e("a",{attrs:{href:"#example-using-caddy-v2"}},[s._v("Example using Caddy v2")])])])]),e("li",[e("a",{attrs:{href:"#deploying"}},[s._v("Deploying")]),e("ul",[e("li",[e("a",{attrs:{href:"#open-connection-limit"}},[s._v("Open Connection Limit")])]),e("li",[e("a",{attrs:{href:"#keeping-the-socket-server-running-with-supervisord"}},[s._v("Keeping the socket server running with supervisord")])]),e("li",[e("a",{attrs:{href:"#cloudflare"}},[s._v("Cloudflare")])])])])])]),e("p"),s._v(" "),e("div",{staticClass:"custom-block danger"},[e("p",{staticClass:"custom-block-title"},[s._v("DANGER")]),s._v(" "),e("p",[s._v("When using websockets as a Pusher replacement without having used Pusher before, "),e("strong",[s._v("it does not matter what you set as your "),e("code",[s._v("PUSHER_")]),s._v(" variables. Just make sure they are unique and not empty")]),s._v(".")])]),s._v(" "),e("h2",{attrs:{id:"pusher-configuration"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pusher-configuration"}},[s._v("#")]),s._v(" Pusher Configuration")]),s._v(" "),e("p",[s._v("When broadcasting events from your Pixelfed server to your WebSocket server, the default behavior is to send the event information to the official Pusher server. But since the Pixelfed WebSockets package comes with its own Pusher API implementation, we need to tell Pixelfed to send the events to our own server.")]),s._v(" "),e("p",[s._v("To do this, you should add the "),e("code",[s._v("host")]),s._v(" and "),e("code",[s._v("port")]),s._v(" configuration key to your "),e("code",[s._v("config/broadcasting.php")]),s._v(" and add it to the "),e("code",[s._v("pusher")]),s._v(" section. The default port of the Pixelfed WebSocket server is 6001.")]),s._v(" "),e("div",{staticClass:"language-php line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-php"}},[e("code",[e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'pusher'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'driver'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'pusher'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'key'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'PUSHER_APP_KEY'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'secret'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'PUSHER_APP_SECRET'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'app_id'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'PUSHER_APP_ID'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'options'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'cluster'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'PUSHER_APP_CLUSTER'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'encrypted'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant boolean"}},[s._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'host'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'PUSHER_APP_HOST'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'127.0.0.1'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'port'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'PUSHER_APP_PORT'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6001")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'scheme'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'PUSHER_APP_SCHEME'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'http'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'curl_options'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n            "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CURLOPT_SSL_VERIFYHOST")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CURLOPT_SSL_VERIFYPEER")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("h2",{attrs:{id:"starting-the-websocket-server"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#starting-the-websocket-server"}},[s._v("#")]),s._v(" Starting the WebSocket server")]),s._v(" "),e("p",[s._v("Once you have configured your WebSocket apps and Pusher settings, you can start the Pixelfed WebSocket server by issuing the artisan command:")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("php artisan websockets:serve\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"using-a-different-port"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#using-a-different-port"}},[s._v("#")]),s._v(" Using a different port")]),s._v(" "),e("p",[s._v("The default port of the Pixelfed WebSocket server is "),e("code",[s._v("6001")]),s._v(". You may pass a different port to the command using the "),e("code",[s._v("--port")]),s._v(" option.")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("php artisan websockets:serve --port"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3030")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("This will start listening on port "),e("code",[s._v("3030")]),s._v(".")]),s._v(" "),e("h3",{attrs:{id:"restricting-the-listening-host"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#restricting-the-listening-host"}},[s._v("#")]),s._v(" Restricting the listening host")]),s._v(" "),e("p",[s._v("By default, the Pixelfed WebSocket server will listen on "),e("code",[s._v("0.0.0.0")]),s._v(" and will allow incoming connections from all networks. If you want to restrict this, you can start the server with a "),e("code",[s._v("--host")]),s._v(" option, followed by an IP.")]),s._v(" "),e("p",[s._v("For example, by using "),e("code",[s._v("127.0.0.1")]),s._v(", you will only allow WebSocket connections from localhost.")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("php artisan websockets:serve --host"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"restarting-server"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#restarting-server"}},[s._v("#")]),s._v(" Restarting Server")]),s._v(" "),e("p",[s._v("If you use Supervisor to keep your server alive, you might want to restart it just like "),e("code",[s._v("queue:restart")]),s._v(" does.")]),s._v(" "),e("p",[s._v("To do so, consider using the "),e("code",[s._v("websockets:restart")]),s._v(". In a maximum of 10 seconds since issuing the command, the server will be restarted.")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("php artisan websockets:restart\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"ssl-support"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ssl-support"}},[s._v("#")]),s._v(" SSL Support")]),s._v(" "),e("p",[s._v("Since most of the web's traffic is going through HTTPS, it's also crucial to secure your WebSocket server. Luckily, adding SSL support to this package is really simple.")]),s._v(" "),e("h3",{attrs:{id:"configuration"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#configuration"}},[s._v("#")]),s._v(" Configuration")]),s._v(" "),e("p",[s._v("The SSL configuration takes place in your "),e("code",[s._v("config/websockets.php")]),s._v(" file.")]),s._v(" "),e("p",[s._v("The default configuration has a SSL section that looks like this:")]),s._v(" "),e("div",{staticClass:"language-php line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-php"}},[e("code",[e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'ssl'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'local_cert'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'LARAVEL_WEBSOCKETS_SSL_LOCAL_CERT'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'capath'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'LARAVEL_WEBSOCKETS_SSL_CA'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'local_pk'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'LARAVEL_WEBSOCKETS_SSL_LOCAL_PK'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'passphrase'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'LARAVEL_WEBSOCKETS_SSL_PASSPHRASE'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant"}},[s._v("null")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'verify_peer'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'APP_ENV'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("===")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'production'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'allow_self_signed'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'APP_ENV'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!==")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'production'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br")])]),e("p",[s._v("But this is only a subset of all the available configuration options.")]),s._v(" "),e("p",[s._v("This packages makes use of the official PHP "),e("a",{attrs:{href:"http://php.net/manual/en/context.ssl.php",target:"_blank",rel:"noopener noreferrer"}},[s._v("SSL context options"),e("OutboundLink")],1),s._v(".")]),s._v(" "),e("p",[s._v("So if you find yourself in the need of adding additional configuration settings, take a look at the PHP documentation and simply add the configuration parameters that you need.")]),s._v(" "),e("p",[s._v("After setting up your SSL settings, you can simply (re)start your WebSocket server using:")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("php artisan websockets:serve\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"server-configuration"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#server-configuration"}},[s._v("#")]),s._v(" Server configuration")]),s._v(" "),e("p",[s._v("When broadcasting events from your Pixelfed server to the WebSocket server, you also need to tell Pixelfed to make use of HTTPS instead of HTTP. You can do this by setting the "),e("code",[s._v("PUSHER_APP_SCHEME")]),s._v(" variable to "),e("code",[s._v("https")])]),s._v(" "),e("div",{staticClass:"language-env line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("PUSHER_APP_SCHEME=https\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("Your connection from "),e("code",[s._v("config/broadcasting.php")]),s._v(" would look like this:")]),s._v(" "),e("div",{staticClass:"language-php line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-php"}},[e("code",[e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'pusher'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'driver'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'pusher'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'key'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'PUSHER_APP_KEY'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'secret'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'PUSHER_APP_SECRET'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'app_id'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'PUSHER_APP_ID'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'options'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'cluster'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'PUSHER_APP_CLUSTER'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'encrypted'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token constant boolean"}},[s._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'host'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'PUSHER_APP_HOST'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'127.0.0.1'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'port'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'PUSHER_APP_PORT'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6001")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'scheme'")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'PUSHER_APP_SCHEME'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string single-quoted-string"}},[s._v("'http'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("p",[s._v("Since the SSL configuration can vary quite a lot, depending on your setup, let's take a look at the most common approaches.")]),s._v(" "),e("h3",{attrs:{id:"usage-with-a-reverse-proxy-like-nginx"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#usage-with-a-reverse-proxy-like-nginx"}},[s._v("#")]),s._v(" Usage with a reverse proxy (like Nginx)")]),s._v(" "),e("p",[s._v("Alternatively, you can also use a proxy service - like Nginx, HAProxy or Caddy - to handle the SSL configurations and proxy all requests in plain HTTP to your echo server.")]),s._v(" "),e("p",[s._v("A basic Nginx configuration would look like this, but you might want to tweak the SSL parameters to your liking.")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("server {\n  listen        443 ssl;\n  listen        [::]:443 ssl;\n  server_name   socket.yourapp.tld;\n\n  # Start the SSL configurations\n  ssl                  on;\n  ssl_certificate      /etc/letsencrypt/live/socket.yourapp.tld/fullchain.pem;\n  ssl_certificate_key  /etc/letsencrypt/live/socket.yourapp.tld/privkey.pem;\n\n  location / {\n    proxy_pass             http://127.0.0.1:6001;\n    proxy_read_timeout     60;\n    proxy_connect_timeout  60;\n    proxy_redirect         off;\n\n    # Allow the use of websockets\n    proxy_http_version 1.1;\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection 'upgrade';\n    proxy_set_header Host $host;\n    proxy_cache_bypass $http_upgrade;\n  }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br")])]),e("p",[s._v("You can now talk HTTPS to "),e("code",[s._v("socket.yourapp.tld")]),s._v(". You would configure your "),e("code",[s._v("config/broadcasting.php")]),s._v(" like the example above, treating your socket server as an "),e("code",[s._v("https")]),s._v(" endpoint.")]),s._v(" "),e("h4",{attrs:{id:"same-location-for-websockets-and-web-contents"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#same-location-for-websockets-and-web-contents"}},[s._v("#")]),s._v(" Same location for websockets and web contents")]),s._v(" "),e("p",[s._v("To have the websockets be served at the same location and port as your other web content, Nginx can be taught to map incoming requests based on their type to special sub-locations.")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('map $http_upgrade $type {\n  default "web";\n  websocket "ws";\n}\n\nserver {\n  # Your default configuration comes here...\n\n  location / {\n    try_files /nonexistent @$type;\n  }\n\n  location @web {\n    try_files $uri $uri/ /index.php?$query_string;\n  }\n\n  location @ws {\n    proxy_pass             http://127.0.0.1:6001;\n    proxy_set_header Host  $host;\n    proxy_read_timeout     60;\n    proxy_connect_timeout  60;\n    proxy_redirect         off;\n\n    # Allow the use of websockets\n    proxy_http_version 1.1;\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection \'upgrade\';\n    proxy_set_header Host $host;\n    proxy_cache_bypass $http_upgrade;\n  }\n}\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br")])]),e("p",[s._v("This configuration is useful if you do not want to open multiple ports or you are restricted to which ports are already opened on your server. Alternatively, a second Nginx location can be used on the server-side, while the Pusher configuration "),e("a",{attrs:{href:"https://github.com/pusher/pusher-js#wspath",target:"_blank",rel:"noopener noreferrer"}},[e("code",[s._v("wsPath")]),e("OutboundLink")],1),s._v(" can be used on the client-side ("),e("em",[s._v("note: "),e("code",[s._v('"pusher-js": ">=4.2.2"')]),s._v(" is required for this configuration option")]),s._v(").")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("server {\n  # Your default configuration comes here...\n\n  location /ws {\n    proxy_pass             http://127.0.0.1:6001;\n    proxy_set_header Host  $host;\n    proxy_read_timeout     60;\n    proxy_connect_timeout  60;\n    proxy_redirect         off;\n\n    # Allow the use of websockets\n    proxy_http_version 1.1;\n    proxy_set_header Upgrade $http_upgrade;\n    proxy_set_header Connection 'upgrade';\n    proxy_set_header Host $host;\n    proxy_cache_bypass $http_upgrade;\n  }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("h4",{attrs:{id:"nginx-worker-connections"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nginx-worker-connections"}},[s._v("#")]),s._v(" Nginx worker connections")]),s._v(" "),e("p",[s._v("Note that you might need to increase the amount of "),e("code",[s._v("worker_connections")]),s._v(" in Nginx. Your WebSocket connections will now be sent to Nginx, which in turn will send those along to the websocket server.")]),s._v(" "),e("p",[s._v("By default, that will have a sane limit of 1024 connections. If you are expecting more concurrent connections to your WebSockets, you can increase this in your global "),e("code",[s._v("nginx.conf")]),s._v(".")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("events {\n    worker_connections  1024;\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("You know you've reached this limit of your Nginx error logs contain similar messages to these:")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[alert] 1024 worker_connections are not enough while connecting to upstream\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("Remember to restart your Nginx after you've modified the "),e("code",[s._v("worker_connections")]),s._v(".")]),s._v(" "),e("h3",{attrs:{id:"example-using-caddy-v2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#example-using-caddy-v2"}},[s._v("#")]),s._v(" Example using Caddy v2")]),s._v(" "),e("p",[e("a",{attrs:{href:"https://caddyserver.com",target:"_blank",rel:"noopener noreferrer"}},[s._v("Caddy"),e("OutboundLink")],1),s._v(" can also be used to automatically obtain a TLS certificate from Let's Encrypt and terminate TLS before proxying to your websocket server.")]),s._v(" "),e("p",[s._v("An example configuration would look like this:")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("socket.yourapp.tld {\n    @ws {\n        header Connection *Upgrade*\n        header Upgrade    websocket\n    }\n    reverse_proxy @ws 127.0.0.1:6001\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("Note that you should change "),e("code",[s._v("127.0.0.1")]),s._v(" to the hostname of your websocket server. For example, if you're running in a Docker environment, this might be the container name of your websocket server.")]),s._v(" "),e("h2",{attrs:{id:"deploying"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#deploying"}},[s._v("#")]),s._v(" Deploying")]),s._v(" "),e("p",[s._v("When your application is ready to get deployed, here are some tips to improve your WebSocket server.")]),s._v(" "),e("h3",{attrs:{id:"open-connection-limit"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#open-connection-limit"}},[s._v("#")]),s._v(" Open Connection Limit")]),s._v(" "),e("p",[s._v('On Unix systems, every user that connects to your WebSocket server is represented as a file somewhere on the system.\nAs a security measurement of every Unix based OS, the number of "file descriptors" an application may have open at a time is limited - most of the time to a default value of 1024 - which would result in a maximum number of 1024 concurrent users on your WebSocket server.')]),s._v(" "),e("p",[s._v('In addition to the OS restrictions, this package makes use of an event loop called "stream_select", which has a hard limit of 1024.')]),s._v(" "),e("h4",{attrs:{id:"increasing-the-maximum-number-of-file-descriptors"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#increasing-the-maximum-number-of-file-descriptors"}},[s._v("#")]),s._v(" Increasing the maximum number of file descriptors")]),s._v(" "),e("p",[s._v('The operating system limit of open "file descriptors" can be increased using the '),e("code",[s._v("ulimit")]),s._v(" command. The "),e("code",[s._v("-n")]),s._v(" option modifies the number of open file descriptors.")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("ulimit")]),s._v(" -n "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("The "),e("code",[s._v("ulimit")]),s._v(" command only "),e("strong",[s._v("temporarily")]),s._v(" increases the maximum number of open file descriptors. To permanently modify this value, you can edit it in your operating system "),e("code",[s._v("limits.conf")]),s._v(" file.")]),s._v(" "),e("p",[s._v("You are best to do so by creating a file in the "),e("code",[s._v("limits.d")]),s._v(" directory. This will work for both Red Hat & Ubuntu derivatives.")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /etc/security/limits.d/laravel-echo.conf\nlaravel-echo        soft        nofile      "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("The above example assumes you will run your echo server as the "),e("code",[s._v("laravel-echo")]),s._v(" user, you are free to change that to your liking.")]),s._v(" "),e("h4",{attrs:{id:"changing-the-event-loop"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#changing-the-event-loop"}},[s._v("#")]),s._v(" Changing the event loop")]),s._v(" "),e("p",[s._v("To make use of a different event loop, that does not have a hard limit of 1024 concurrent connections, you can either install the "),e("code",[s._v("ev")]),s._v(" or "),e("code",[s._v("event")]),s._v(" PECL extension using:")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" pecl "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" ev\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# or")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" pecl "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" event\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h4",{attrs:{id:"deploying-on-laravel-forge"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#deploying-on-laravel-forge"}},[s._v("#")]),s._v(" Deploying on Laravel Forge")]),s._v(" "),e("p",[s._v("If your are using "),e("a",{attrs:{href:"https://forge.laravel.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Laravel Forge"),e("OutboundLink")],1),s._v(" for the deployment "),e("a",{attrs:{href:"https://alex.bouma.dev/installing-laravel-websockets-on-forge",target:"_blank",rel:"noopener noreferrer"}},[s._v("this article by Alex Bouma"),e("OutboundLink")],1),s._v(" might help you out.")]),s._v(" "),e("h3",{attrs:{id:"keeping-the-socket-server-running-with-supervisord"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#keeping-the-socket-server-running-with-supervisord"}},[s._v("#")]),s._v(" Keeping the socket server running with supervisord")]),s._v(" "),e("p",[s._v("The "),e("code",[s._v("websockets:serve")]),s._v(" daemon needs to always be running in order to accept connections. This is a prime use case for "),e("code",[s._v("supervisor")]),s._v(", a task runner on Linux.")]),s._v(" "),e("p",[s._v("First, make sure "),e("code",[s._v("supervisor")]),s._v(" is installed.")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# On Debian / Ubuntu")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" supervisor\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# On Red Hat / CentOS")]),s._v("\nyum "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" supervisor\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" supervisord\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("Once installed, add a new process that "),e("code",[s._v("supervisor")]),s._v(" needs to keep running. You place your configurations in the "),e("code",[s._v("/etc/supervisor/conf.d")]),s._v(" (Debian/Ubuntu) or "),e("code",[s._v("/etc/supervisord.d")]),s._v(" (Red Hat/CentOS) directory.")]),s._v(" "),e("p",[s._v("Within that directory, create a new file called "),e("code",[s._v("websockets.conf")]),s._v(".")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("program:websockets"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("command")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/bin/php /home/laravel-echo/laravel-websockets/artisan websockets:serve\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("numprocs")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("autostart")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("autorestart")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("user")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("laravel-echo\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("Once created, instruct "),e("code",[s._v("supervisor")]),s._v(" to reload its configuration files (without impacting the already running "),e("code",[s._v("supervisor")]),s._v(" jobs).")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("supervisorctl update\nsupervisorctl start websockets\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("Your echo server should now be running (you can verify this with "),e("code",[s._v("supervisorctl status")]),s._v("). If it were to crash, "),e("code",[s._v("supervisor")]),s._v(" will automatically restart it.")]),s._v(" "),e("p",[s._v("Please note that, by default, just like file descriptiors,  "),e("code",[s._v("supervisor")]),s._v(" will force a maximum number of open files onto all the processes that it manages. This is configured by the "),e("code",[s._v("minfds")]),s._v(" parameter in "),e("code",[s._v("supervisord.conf")]),s._v(".")]),s._v(" "),e("p",[s._v("If you want to increase the maximum number of open files, you may do so in "),e("code",[s._v("/etc/supervisor/supervisord.conf")]),s._v(" (Debian/Ubuntu) or "),e("code",[s._v("/etc/supervisord.conf")]),s._v(" (Red Hat/CentOS):")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[supervisord]\nminfds=10240; (min. avail startup file descriptors;default 1024)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("After changing this setting, you'll need to restart the supervisor process (which in turn will restart all your processes that it manages).")]),s._v(" "),e("h3",{attrs:{id:"cloudflare"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#cloudflare"}},[s._v("#")]),s._v(" Cloudflare")]),s._v(" "),e("p",[s._v("In some cases, you might use Cloudflare and notice that your production server does not seem to respond to your "),e("code",[s._v(":6001")]),s._v(" port.")]),s._v(" "),e("p",[s._v("This is because Cloudflare does not seem to open ports, "),e("a",{attrs:{href:"https://blog.cloudflare.com/cloudflare-now-supporting-more-ports/",target:"_blank",rel:"noopener noreferrer"}},[s._v("excepting a few of them"),e("OutboundLink")],1),s._v(".")]),s._v(" "),e("p",[s._v("To mitigate this issue, for example, you can run your server on port "),e("code",[s._v("2096")]),s._v(":")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("php artisan websockets:serve --port"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2096")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("You will notice that the new "),e("code",[s._v(":2096")]),s._v(" websockets server will work properly.")])])}),[],!1,null,null,null);t.default=a.exports}}]);